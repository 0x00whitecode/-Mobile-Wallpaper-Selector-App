name: Build React Native App (Windows + iOS)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ü™ü Windows Build Job
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure npm/yarn
        run: |
          npm config set legacy-peer-deps true
          yarn config set ignore-engines true

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        run: yarn install --ignore-engines

      # ‚úÖ FIX: Detect React Native version and install matching react-native-windows
      - name: Install compatible React Native Windows
        run: |
          # Get the installed react-native version
          $rnVersion = node -p "require('./node_modules/react-native/package.json').version"
          Write-Host "Detected React Native version: $rnVersion"
          
          # Extract major.minor version (e.g., "0.76" from "0.76.3")
          $rnMajorMinor = $rnVersion -replace '^(\d+\.\d+).*', '$1'
          Write-Host "Looking for react-native-windows@^$rnMajorMinor"
          
          # Set error action preference to catch errors
          $ErrorActionPreference = "Stop"
          
          # Try to install matching version
          $installed = $false
          try {
            yarn add "react-native-windows@^$rnMajorMinor" --dev --ignore-engines 2>&1 | Tee-Object -Variable output
            if ($LASTEXITCODE -eq 0) {
              yarn add "@react-native-windows/cli@^$rnMajorMinor" --dev --ignore-engines
              if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Installed react-native-windows@^$rnMajorMinor"
                $installed = $true
              }
            }
          } catch {
            Write-Host "‚ö†Ô∏è Error during installation: $_"
          }
          
          # If matching version failed, try latest
          if (-not $installed -or $LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è No matching version found for $rnMajorMinor. Installing latest..."
            yarn add react-native-windows@latest --dev --ignore-engines
            if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå Failed to install react-native-windows@latest"
              exit 1
            }
            yarn add @react-native-windows/cli@latest --dev --ignore-engines
            if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå Failed to install @react-native-windows/cli@latest"
              exit 1
            }
            Write-Host "‚úÖ Installed react-native-windows@latest"
          }
          
          # Verify installation
          $rnwVersion = node -p "require('./node_modules/react-native-windows/package.json').version"
          Write-Host "Final react-native-windows version: $rnwVersion"
        shell: pwsh

      # ‚úÖ Initialize Windows project with error handling
      - name: Add Windows project
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "Initializing Windows project..."
          npx react-native-windows-init --overwrite --verbose 2>&1 | Tee-Object -Variable output
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è Standard initialization failed, trying alternative approach..."
            
            # If auto-matching fails, manually specify version
            $rnwVersion = node -p "require('./node_modules/react-native-windows/package.json').version"
            Write-Host "Manually initializing with react-native-windows@$rnwVersion"
            
            npx react-native-windows-init --overwrite --version $rnwVersion --verbose
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå Both initialization attempts failed"
              Write-Host $output
              exit 1
            }
          }
          
          Write-Host "‚úÖ Windows initialization successful"
        shell: pwsh

      # ‚úÖ Verify Windows project exists before building
      - name: Verify Windows project
        run: |
          if (Test-Path -Path "windows") {
            Write-Host "‚úÖ Windows directory exists"
            Get-ChildItem windows
          } else {
            Write-Host "‚ùå Windows directory not found!"
            exit 1
          }
        shell: pwsh

      # ‚úÖ Build Windows app with error handling
      - name: Build Windows app
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "Building Windows app..."
          npx react-native run-windows --release --arch x64 --no-deploy --logging 2>&1 | Tee-Object -Variable buildOutput
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Build failed"
            Write-Host "=== Last 100 lines of output ==="
            Write-Host $buildOutput[-100..-1]
            
            if (Test-Path -Path "windows/msbuild.log") {
              Write-Host "=== MSBuild Log (last 100 lines) ==="
              Get-Content windows/msbuild.log -Tail 100
            }
            exit 1
          }
          
          Write-Host "‚úÖ Windows build successful"
        shell: pwsh

      # ‚úÖ Find and display all build outputs
      - name: Locate build outputs
        run: |
          Write-Host "=== Searching for build outputs ==="
          
          # Search for .exe files
          Write-Host "`nüì¶ EXE files:"
          Get-ChildItem -Path "windows" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName)"
            Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB"
          }
          
          # Search for .msix files
          Write-Host "`nüì¶ MSIX packages:"
          Get-ChildItem -Path "windows" -Recurse -Filter "*.msix" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName)"
            Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB"
          }
          
          # Search for .appx files
          Write-Host "`nüì¶ APPX packages:"
          Get-ChildItem -Path "windows" -Recurse -Filter "*.appx" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName)"
            Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB"
          }
          
          # List all Release directories
          Write-Host "`nüìÅ Release directories:"
          Get-ChildItem -Path "windows" -Recurse -Directory -Filter "Release" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  $($_.FullName)"
            Get-ChildItem -Path $_.FullName -File | ForEach-Object {
              Write-Host "    - $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)"
            }
          }
          
          # List AppPackages directory if it exists
          if (Test-Path -Path "windows/AppPackages") {
            Write-Host "`nüìÅ AppPackages contents:"
            Get-ChildItem -Path "windows/AppPackages" -Recurse -File | ForEach-Object {
              Write-Host "  $($_.FullName.Replace((Get-Location).Path + '\', ''))"
            }
          }
        shell: pwsh

      # ‚úÖ Upload the built Windows installer - Multiple attempts to catch the .exe
      - name: Upload Windows installer (AppPackages)
        uses: actions/upload-artifact@v4
        with:
          name: windows-app-packages
          path: |
            windows/AppPackages/**/*
        if: always()
        continue-on-error: true

      - name: Upload Windows installer (Release binaries)
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-binaries
          path: |
            windows/**/bin/x64/Release/**
            windows/**/bin/Release/**
        if: always()
        continue-on-error: true

      - name: Upload Windows installer (All executables)
        uses: actions/upload-artifact@v4
        with:
          name: windows-executables
          path: |
            windows/**/*.exe
            windows/**/*.msix
            windows/**/*.appx
        if: always()
        continue-on-error: true

      - name: Upload complete Windows folder (last resort)
        uses: actions/upload-artifact@v4
        with:
          name: windows-complete-build
          path: windows/
          if-no-files-found: warn
        if: always()

      # ‚úÖ Upload build logs
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-logs
          path: |
            windows/msbuild.log
            windows/**/*.log
        if: always()


  # üçé iOS Build Job
  build-ios:
    runs-on: macos-latest
    needs: build-windows  # Remove if you want parallel builds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure npm/yarn
        run: |
          npm config set legacy-peer-deps true
          yarn config set ignore-engines true

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install dependencies
        run: yarn install --ignore-engines

      - name: Setup iOS pods
        working-directory: ios
        run: pod install

      - name: Log in to Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas whoami || eas login --token $EXPO_TOKEN

      - name: Build iOS .ipa
        run: eas build -p ios --profile production --non-interactive

      - name: Upload iOS build info
        run: echo "‚úÖ iOS build complete ‚Äî check Expo Dashboard for your .ipa download link"