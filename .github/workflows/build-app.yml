name: Build React Native App (Windows + iOS)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ü™ü Windows Build Job
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure npm/yarn
        run: |
          npm config set legacy-peer-deps true
          yarn config set ignore-engines true

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        run: yarn install --ignore-engines

      # ‚úÖ FIX: Detect React Native version and install matching react-native-windows
      - name: Install compatible React Native Windows
        run: |
          # Get the installed react-native version
          $rnVersion = node -p "require('./node_modules/react-native/package.json').version"
          Write-Host "Detected React Native version: $rnVersion"
          
          # Extract major.minor version (e.g., "0.76" from "0.76.3")
          $rnMajorMinor = $rnVersion -replace '^(\d+\.\d+).*', '$1'
          Write-Host "Looking for react-native-windows@^$rnMajorMinor"
          
          # Try to install matching version, fallback to latest if not found
          try {
            yarn add "react-native-windows@^$rnMajorMinor" --dev --ignore-engines
            yarn add "@react-native-windows/cli@^$rnMajorMinor" --dev --ignore-engines
            Write-Host "‚úÖ Installed react-native-windows@^$rnMajorMinor"
          } catch {
            Write-Host "‚ö†Ô∏è No matching version found. Installing latest..."
            yarn add react-native-windows@latest --dev --ignore-engines
            yarn add @react-native-windows/cli@latest --dev --ignore-engines
          }
        shell: pwsh

      # ‚úÖ Initialize Windows project with error handling
      - name: Add Windows project
        run: |
          try {
            npx react-native-windows-init --overwrite --verbose
            Write-Host "‚úÖ Windows initialization successful"
          } catch {
            Write-Host "‚ö†Ô∏è Initialization failed, trying alternative approach..."
            
            # If auto-matching fails, manually specify version
            $rnwVersion = node -p "require('./node_modules/react-native-windows/package.json').version"
            Write-Host "Manually initializing with react-native-windows@$rnwVersion"
            
            npx react-native-windows-init --overwrite --version $rnwVersion --verbose
          }
        shell: pwsh
        continue-on-error: false

      # ‚úÖ Verify Windows project exists before building
      - name: Verify Windows project
        run: |
          if (Test-Path -Path "windows") {
            Write-Host "‚úÖ Windows directory exists"
            Get-ChildItem windows
          } else {
            Write-Host "‚ùå Windows directory not found!"
            exit 1
          }
        shell: pwsh

      # ‚úÖ Build Windows app with error handling
      - name: Build Windows app
        run: |
          try {
            npx react-native run-windows --release --arch x64 --no-deploy --logging
            Write-Host "‚úÖ Windows build successful"
          } catch {
            Write-Host "‚ö†Ô∏è Build failed, checking logs..."
            if (Test-Path -Path "windows/msbuild.log") {
              Get-Content windows/msbuild.log -Tail 100
            }
            throw
          }
        shell: pwsh

      # ‚úÖ Upload the built Windows installer
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: |
            windows/AppPackages/**/*
            windows/**/Release/**/*.exe
            windows/**/Release/**/*.msix
        if: success()

      # ‚úÖ Upload build logs on failure
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-logs
          path: |
            windows/msbuild.log
            windows/**/*.log
        if: failure()


  # üçé iOS Build Job
  build-ios:
    runs-on: macos-latest
    needs: build-windows  # Remove if you want parallel builds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure npm/yarn
        run: |
          npm config set legacy-peer-deps true
          yarn config set ignore-engines true

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install dependencies
        run: yarn install --ignore-engines

      - name: Setup iOS pods
        working-directory: ios
        run: pod install

      - name: Log in to Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas whoami || eas login --token $EXPO_TOKEN

      - name: Build iOS .ipa
        run: eas build -p ios --profile production --non-interactive

      - name: Upload iOS build info
        run: echo "‚úÖ iOS build complete ‚Äî check Expo Dashboard for your .ipa download link"